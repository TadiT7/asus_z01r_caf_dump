#!/system/bin/sh

ON="/proc/driver/ois_power"
MODE="/proc/driver/ois_mode"
RC="/proc/driver/ois_atd_status"

TIMESTAMP="/proc/uptime"

LOG="/proc/fac_printklog"

function usage()
{
    echo "
API: ATD TestCommand Interface

FORMAT: adb shell /data/data/Camera_OIS Para1

USAGE:
(Para1) 0 = Servo off
        1 = operate for preview & video
        2 = operate for capture
(Para2) timeout value (seconds)
"
}

function power_on()
{
	echo 1 > $ON
}

function power_off()
{
	echo 0 > $ON
}

function switch_mode()
{
	echo $1 > $MODE
}

function cat_status()
{
	cat $RC
}

function do_process_with_timout()
{
	start_time=$(cat $TIMESTAMP|cut -d ' ' -f 1)
	switch_mode $1
	end_time=$(cat $TIMESTAMP|cut -d ' ' -f 1)

	#echo "start $start_time, end $end_time"
	cost_time=$(busybox awk 'BEGIN{print "'$end_time'" - "'$start_time'" }')
	#echo "Cost time is $cost_time"

	echo $cost_time $2 | busybox awk '{if($1>$2) {printf"0\n"} else {printf"1\n"}}'
}


[ -e $LOG ] && echo "$0 $*"> $LOG


if [ $# -eq 1 ]
then
	timeout=1
elif [ $# -eq 2 ]
then
	echo $2|grep -Eqi "^[0-9]+$"
	rc=$?
	if [ $rc -ne 0 ]
	then
		echo "0"
		echo "please input legal decimal format for timeout value!"
		exit 1
	else
		timeout=$2
	fi
else
	echo "0"
	usage
	exit 1
fi


power_state=$(cat $ON)
if [ $power_state -eq 0 ]
then
	echo "0"
	echo "OIS power down, must open camera first!"
	exit 1
fi

case $1 in
"0")
	do_process_with_timout 0 $timeout
;;
"1")
	do_process_with_timout 1 $timeout
;;
"2")
	do_process_with_timout 2 $timeout
;;
*)
	echo "0"
	usage
;;
esac
